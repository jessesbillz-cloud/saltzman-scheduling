<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WPMS Inspection Request</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,sans-serif;max-width:500px;margin:0 auto;padding:12px;background:#111;}
.header{margin-bottom:12px;}
.header h2{font-size:18px;margin-bottom:2px;color:#fff;}
.header p{color:#888;font-size:13px;}
.tabs{display:flex;border-bottom:2px solid #333;margin-bottom:0;}
.tab{flex:1;text-align:center;padding:10px;font-size:14px;font-weight:600;cursor:pointer;color:#666;border-bottom:2px solid transparent;margin-bottom:-2px;}
.tab.active{color:#e8742a;border-bottom-color:#e8742a;}
.card{background:#1a1a1a;border:1px solid #333;border-radius:8px;overflow:hidden;margin-bottom:12px;}
.card-top{border-radius:8px 8px 0 0;border-top:none;}
.cal-nav{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #333;}
.cal-nav button{background:none;border:none;font-size:18px;cursor:pointer;padding:4px 10px;color:#888;}
.cal-nav strong{font-size:15px;color:#fff;}
.week-row{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;}
.week-header{font-size:11px;color:#666;padding:6px 0;font-weight:600;}
.day-cell{padding:8px 4px;font-size:13px;cursor:pointer;min-height:40px;color:#ccc;}
.day-cell:hover{background:#222;}
.day-cell.selected{background:#1e2a3a;border-radius:6px;}
.day-cell.today .day-num{background:#3a6fb0;color:#fff;border-radius:50%;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;}
.day-cell.other-month{color:#444;}
.day-dot{width:80%;height:3px;border-radius:2px;margin:3px auto 0;}
.day-detail{padding:12px 14px;border-top:1px solid #333;display:none;}
.day-detail-header{font-size:13px;font-weight:bold;color:#fff;margin-bottom:8px;}
.evt-row{padding:8px 0;border-bottom:1px solid #2a2a2a;font-size:13px;color:#fff;}
.evt-row:last-child{border-bottom:none;}
.evt-time{font-weight:600;color:#fff;}
.evt-type{font-size:11px;font-weight:600;margin-left:4px;color:#888;}
.evt-actions{margin-top:4px;}
.evt-actions button{font-size:11px;padding:3px 10px;margin-right:6px;border-radius:4px;cursor:pointer;background:transparent;}
.evt-actions .btn-edit{color:#e8742a;border:1px solid #e8742a;}
.evt-actions .btn-cancel{color:#c44;border:1px solid #c44;}
.evt-cancelled{opacity:0.4;}
.evt-cancelled .evt-time,.evt-cancelled .evt-type{text-decoration:line-through;}
.cancelled-label{font-size:10px;color:#c44;font-weight:600;margin-left:6px;}
.evt-who{color:#888;font-size:12px;margin-top:2px;}
.evt-notes{color:#666;font-size:11px;font-style:italic;margin-top:2px;}
.no-events{color:#555;font-size:12px;padding:4px 0;}
.form-wrap{background:#1a1a1a;border:1px solid #333;border-top:none;border-radius:0 0 8px 8px;padding:16px;display:none;}
.field-label{display:block;font-weight:bold;font-size:13px;margin-bottom:5px;color:#ccc;}
.field-input{width:100%;padding:10px;font-size:15px;border:1px solid #444;border-radius:6px;margin-bottom:14px;background:#222;color:#fff;}
select.field-input{background:#222;color:#fff;}
.photo-box{border:2px dashed #444;border-radius:8px;padding:30px 16px;text-align:center;background:#1a1a1a;cursor:pointer;margin-bottom:14px;color:#888;}
.photo-box.has-file{border-style:solid;border-color:#3a6fb0;}
.type-btns{display:flex;gap:8px;margin-bottom:14px;}
.type-btn{flex:1;padding:12px;font-size:14px;font-weight:bold;border:2px solid #444;border-radius:8px;background:#222;cursor:pointer;text-align:center;color:#ccc;}
.type-btn.active{background:#e8742a;color:#fff;border-color:#5a8fc0;}
.dur-btns{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;}
.dur-btn{padding:10px 0;font-size:13px;font-weight:600;border:2px solid #444;border-radius:8px;background:#222;cursor:pointer;text-align:center;color:#ccc;flex:1;min-width:55px;}
.dur-btn.active{background:#e8742a;color:#fff;border-color:#5a8fc0;}
.special-sub{display:none;margin-bottom:14px;}
.special-sub.show{display:block;}
.email-list{background:#222;border:1px solid #333;border-radius:6px;padding:8px 12px;margin-bottom:16px;}
.email-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid #333;font-size:13px;color:#ccc;}
.email-row:last-child{border-bottom:none;}
.email-row input{width:18px;height:18px;}
.submit-btn{width:100%;padding:14px;font-size:15px;font-weight:bold;color:#fff;background:#e8742a;border:none;border-radius:8px;cursor:pointer;}
.submit-btn:disabled{opacity:0.6;}
.success-view{display:none;text-align:center;padding:60px 20px;color:#fff;}
.success-view h2{margin:12px 0 8px;}
.reset-btn{margin-top:16px;padding:10px 20px;font-size:14px;font-weight:bold;color:#5a8fc0;background:none;border:2px solid #5a8fc0;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>
<div class="header">
<h2>Inspection Request</h2>
<p>Woodland Park MOD — Lusardi</p>
</div>
<div class="tabs" id="tabBar">
<div class="tab active" onclick="switchTab('calendar')">Calendar</div>
<div class="tab" onclick="switchTab('request')">New Request</div>
</div>
<div id="calendarView">
<div class="card card-top" style="border-top:none;border-radius:0;">
<div class="cal-nav">
<button onclick="changeMonth(-1)">&larr;</button>
<strong id="monthLabel"></strong>
<button onclick="changeMonth(1)">&rarr;</button>
</div>
<div class="week-row" style="padding:0 8px;">
<div class="week-header">S</div><div class="week-header">M</div><div class="week-header">T</div><div class="week-header">W</div><div class="week-header">T</div><div class="week-header">F</div><div class="week-header">S</div>
</div>
<div id="calGrid" class="week-row" style="padding:0 8px;"></div>
<div class="day-detail" id="dayDetail">
<div class="day-detail-header" id="dayDetailHeader"></div>
<div id="dayDetailList"></div>
</div>
</div>
<div class="card">
<div style="padding:20px;text-align:center;">
<img src="image0-5.jpeg" alt="Reports Logo" style="width:80px;height:80px;margin-bottom:8px;">
<div style="font-size:24px;font-weight:bold;color:#5a8fc0;margin-bottom:4px;">My Daily Reports</div>
<div style="font-size:13px;color:#888;margin-bottom:12px;">Professional inspection documentation</div>
<button style="padding:8px 16px;font-size:13px;font-weight:600;color:#fff;background:#e8742a;border:none;border-radius:6px;cursor:pointer;" onclick="window.open('https://mydailyreports.org','_blank')">Learn More</button>
</div>
</div>
<div class="card">
<div style="padding:16px;font-size:12px;color:#888;line-height:1.4;">
<strong style="color:#5a8fc0;">Quick Guide:</strong>
<span style="color:#e8742a;">Click any day</span> to see live schedule from all jobsites •
<span style="color:#e8742a;">Numbers</span> show inspection count per day •
<span style="color:#e8742a;">Additional emails</span> can be saved as permanent checkboxes
</div>
</div>
</div>
<div id="requestView" class="form-wrap">
<label class="field-label">Photo or PDF of Inspection Request *</label>
<div class="photo-box" id="photoBox" onclick="document.getElementById('photoIn').click()">
<div id="photoPrompt">&#128247; Tap to take photo, upload image, or select PDF</div>
<img id="photoPreview" style="display:none;max-width:100%;max-height:250px;border-radius:4px;">
<div id="pdfLabel" style="display:none;font-size:15px;color:#2d7a3a;font-weight:bold;padding:10px;"></div>
</div>
<input type="file" id="photoIn" onchange="showPhoto(this)" style="display:none;">
<label class="field-label">Inspection Date *</label>
<input type="date" id="iDate" class="field-input">
<label class="field-label">Inspection Time *</label>
<select id="iTime" class="field-input">
<option value="">Select time</option>
<option value="flexible">Flexible — anytime today</option>
<option value="05:00">5:00 AM</option><option value="05:30">5:30 AM</option>
<option value="06:00">6:00 AM</option><option value="06:30">6:30 AM</option>
<option value="07:00">7:00 AM</option><option value="07:30">7:30 AM</option>
<option value="08:00">8:00 AM</option><option value="08:30">8:30 AM</option>
<option value="09:00">9:00 AM</option><option value="09:30">9:30 AM</option>
<option value="10:00">10:00 AM</option><option value="10:30">10:30 AM</option>
<option value="11:00">11:00 AM</option><option value="11:30">11:30 AM</option>
<option value="12:00">12:00 PM</option><option value="12:30">12:30 PM</option>
<option value="13:00">1:00 PM</option><option value="13:30">1:30 PM</option>
<option value="14:00">2:00 PM</option><option value="14:30">2:30 PM</option>
<option value="15:00">3:00 PM</option><option value="15:30">3:30 PM</option>
<option value="16:00">4:00 PM</option><option value="16:30">4:30 PM</option>
<option value="17:00">5:00 PM</option>
</select>
<label class="field-label">Duration *</label>
<div class="dur-btns" id="durBtns">
<div class="dur-btn" onclick="setDur('30')">30 min</div>
<div class="dur-btn" onclick="setDur('60')">1 hr</div>
<div class="dur-btn" onclick="setDur('120')">2 hr</div>
<div class="dur-btn" onclick="setDur('240')">4 hr</div>
<div class="dur-btn" onclick="setDur('480')">All Day</div>
</div>
<label class="field-label">Inspection Type *</label>
<div class="type-btns">
<div class="type-btn" id="btnSpecial" onclick="setType('Special')">Special</div>
<div class="type-btn" id="btnRegular" onclick="setType('IOR')">IOR</div>
</div>
<div class="special-sub" id="specialSub">
<label class="field-label">Special Inspection Type *</label>
<select class="field-input" id="specialType">
<option value="">Select type</option>
<option value="Material ID">Material ID</option>
<option value="CWI">CWI (Welding)</option>
<option value="Bolting">Bolting</option>
<option value="Pull Test">Pull Test</option>
<option value="Soils">Soils</option>
<option value="Concrete">Concrete</option>
<option value="Shotcrete">Shotcrete</option>
<option value="Fireproofing">Fireproofing</option>
</select>
</div>
<label class="field-label">Submitted By *</label>
<select id="iName" class="field-input" onchange="toggleOtherName()">
<option value="">Select your name</option>
<option value="Jesse Saltzman">Jesse Saltzman</option>
<option value="Ron Davis">Ron Davis</option>
<option value="Scuyler Beltran">Scuyler Beltran</option>
<option value="Alejandro Martinez">Alejandro Martinez</option>
<option value="__other__">Other</option>
</select>
<input type="text" id="iNameOther" class="field-input" placeholder="Enter your name" style="display:none;">
<label class="field-label">Notes</label>
<textarea id="iNotes" class="field-input" rows="3" placeholder="Optional — any additional details" style="resize:vertical;"></textarea>
<label class="field-label">Send a copy to:</label>
<div class="email-list">
<label class="email-row"><input type="checkbox" value="saltzman.jesse@gmail.com" class="emailCheck">Jesse Saltzman</label>
<label class="email-row"><input type="checkbox" value="rdavis@lusardi.com" class="emailCheck">Ron Davis</label>
<label class="email-row"><input type="checkbox" value="sbeltran@lusardi.com" class="emailCheck">Scuyler Beltran</label>
<label class="email-row"><input type="checkbox" value="amartinez@lusardi.com" class="emailCheck">Alejandro Martinez</label>
</div>
<label style="display:flex;align-items:center;gap:8px;margin:12px 0 8px 0;font-size:13px;color:#ccc;cursor:pointer;">
<input type="checkbox" id="additionalEmailsCheck" onchange="toggleAdditionalEmails()" style="width:18px;height:18px;">
Additional emails
</label>
<div id="additionalEmailsWrap" style="display:none;">
<input type="text" id="additionalEmailsList" class="field-input" placeholder="Enter additional emails separated by commas" style="font-size:13px;" onblur="checkForNewEmails()">
<div style="font-size:11px;color:#888;margin-top:4px;">Separate multiple emails with commas</div>
<div id="saveEmailPrompt" style="display:none;margin-top:8px;padding:10px;background:#2a3a2a;border-radius:4px;border-left:3px solid #e8742a;">
<div style="font-size:12px;color:#ccc;margin-bottom:6px;">Save new email addresses as permanent options?</div>
<div id="newEmailsList" style="font-size:11px;color:#5a8fc0;margin-bottom:8px;"></div>
<button onclick="saveNewEmails()" style="background:#e8742a;color:#fff;border:none;padding:4px 12px;border-radius:4px;font-size:11px;margin-right:8px;cursor:pointer;">Save Permanently</button>
<button onclick="dismissSavePrompt()" style="background:#555;color:#fff;border:none;padding:4px 12px;border-radius:4px;font-size:11px;cursor:pointer;">Not Now</button>
</div>
<div style="font-size:11px;color:#888;margin-top:4px;">Separate multiple emails with commas</div>
</div>
<button onclick="submitIR()" id="submitBtn" class="submit-btn">Submit Inspection Request</button>
</div>
<div class="success-view" id="successView">
<div style="font-size:48px;">&#9989;</div>
<h2>Request Submitted</h2>
<p>Sent to Jesse Saltzman. It will appear on his calendar.</p>
<p id="emailNote" style="color:#666;font-size:12px;display:none;"></p>
<button onclick="resetForm()" class="reset-btn">Submit Another</button>
</div>
<script>
var SB='https://esxeusjjeuyhwwrtwpcv.supabase.co';
var PROJ='WPMS';
var AK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeGV1c2pqZXV5aHd3cnR3cGN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3Mzg0MDYsImV4cCI6MjA4NjMxNDQwNn0.dBEhvcxnscwk1gmb3FGYexmLlrzbd60NFzkt4771IvE';
var photoFile=null,inspType='',inspDur='';
var cM=new Date().getMonth(),cY=new Date().getFullYear();
var mD={},selDate=null,allEvents=[];
var DN=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
var MN=['January','February','March','April','May','June','July','August','September','October','November','December'];
function fmt(t){var h=parseInt(t.split(':')[0]),m=t.split(':')[1],a=h>=12?'PM':'AM';if(h>12)h-=12;if(h===0)h=12;return h+':'+m+' '+a;}
function pad(n){return n<10?'0'+n:n;}
function pad(n){return String(n).padStart(2,'0');}
function ds(y,m,d){return y+'-'+pad(m+1)+'-'+pad(d);}
function fmtDate(s){var p=s.split('-');var dt=new Date(parseInt(p[0]),parseInt(p[1])-1,parseInt(p[2]));return DN[dt.getDay()]+' '+parseInt(p[1])+'.'+parseInt(p[2])+'.'+p[0].substring(2);}
function switchTab(t){
document.querySelectorAll('.tab')[0].classList.toggle('active',t==='calendar');
document.querySelectorAll('.tab')[1].classList.toggle('active',t==='request');
document.getElementById('calendarView').style.display=t==='calendar'?'block':'none';
document.getElementById('requestView').style.display=t==='request'?'block':'none';
}
function checkForNewEmails(){
var emailText=document.getElementById('additionalEmailsList').value.trim();
if(!emailText)return;
var emails=emailText.split(',').map(function(e){return e.trim();}).filter(function(e){return e&&e.includes('@');});
var existingEmails=getExistingEmails();
var newEmails=emails.filter(function(e){return !existingEmails.includes(e.toLowerCase());});
if(newEmails.length>0){
document.getElementById('newEmailsList').textContent=newEmails.join(', ');
document.getElementById('saveEmailPrompt').style.display='block';
}
}
function getExistingEmails(){
var existing=[];
document.querySelectorAll('.emailCheck').forEach(function(cb){existing.push(cb.value.toLowerCase());});
var saved=localStorage.getItem('permanentEmails');
if(saved){existing=existing.concat(JSON.parse(saved).map(function(e){return e.toLowerCase();}));}
return existing;
}
function saveNewEmails(){
var emailText=document.getElementById('additionalEmailsList').value.trim();
var emails=emailText.split(',').map(function(e){return e.trim();}).filter(function(e){return e&&e.includes('@');});
var existingEmails=getExistingEmails();
var newEmails=emails.filter(function(e){return !existingEmails.includes(e.toLowerCase());});
if(newEmails.length>0){
var saved=localStorage.getItem('permanentEmails');
var permanentEmails=saved?JSON.parse(saved):[];
permanentEmails=permanentEmails.concat(newEmails);
localStorage.setItem('permanentEmails',JSON.stringify(permanentEmails));
addPermanentEmailCheckboxes();
}
dismissSavePrompt();
}
function dismissSavePrompt(){
document.getElementById('saveEmailPrompt').style.display='none';
}
function addPermanentEmailCheckboxes(){
var saved=localStorage.getItem('permanentEmails');
if(!saved)return;
var emails=JSON.parse(saved);
var emailList=document.querySelector('.email-list');
emails.forEach(function(email){
if(!document.querySelector('.emailCheck[value="'+email+'"]')){
var label=document.createElement('label');
label.className='email-row';
label.innerHTML='<input type="checkbox" value="'+email+'" class="emailCheck">'+email;
emailList.appendChild(label);
}
});
}
function changeMonth(dir){
cM+=dir;if(cM>11){cM=0;cY++;}if(cM<0){cM=11;cY--;}
selDate=null;document.getElementById('dayDetail').style.display='none';loadMD();
}
function renderCal(){
document.getElementById('monthLabel').textContent=MN[cM]+' '+cY;
var g=document.getElementById('calGrid');g.innerHTML='';
var f=new Date(cY,cM,1),ld=new Date(cY,cM+1,0).getDate(),sd=f.getDay(),today=new Date();
var pl=new Date(cY,cM,0).getDate();
for(var i=sd-1;i>=0;i--){var c=document.createElement('div');c.className='day-cell other-month';c.innerHTML='<span class="day-num">'+(pl-i)+'</span>';g.appendChild(c);}
for(var d=1;d<=ld;d++){
var s=ds(cY,cM,d),c=document.createElement('div');
c.className='day-cell';
if(d===today.getDate()&&cM===today.getMonth()&&cY===today.getFullYear())c.className+=' today';
if(s===selDate)c.className+=' selected';
c.innerHTML='<span class="day-num">'+d+'</span>';
if(mD[s]&&mD[s].length>0){
var visible=mD[s].filter(function(ev){
var isSpecial=(ev.inspection_types||[]).join('').toLowerCase().indexOf('special')>=0;
return ev.project===PROJ||!isSpecial;
});
var hasOwn=visible.some(function(ev){return ev.project===PROJ;});
var hasOther=visible.some(function(ev){return ev.project!==PROJ;});
var total=visible.length;
if(total>0){
c.innerHTML+='<div style="font-size:12px;color:#5a8fc0;text-align:center;margin-top:3px;font-weight:700;">'+total+'</div>';
}
}
c.onclick=(function(x){return function(){selDate=x;renderCal();showDay(x);};})(s);
g.appendChild(c);
}
var rem=(sd+ld)%7;if(rem>0)for(var i=1;i<=7-rem;i++){var c=document.createElement('div');c.className='day-cell other-month';c.innerHTML='<span class="day-num">'+i+'</span>';g.appendChild(c);}
}
function showDay(d){
var wrap=document.getElementById('dayDetail');
var header=document.getElementById('dayDetailHeader');
var list=document.getElementById('dayDetailList');
header.textContent=fmtDate(d);
var evts=mD[d]||[];
if(evts.length===0){
list.innerHTML='<div class="no-events">No inspections scheduled</div>';
}else{
var html='';
evts.forEach(function(e){
var ty=(e.inspection_types||[]).join(', ')||'IOR';
var tyShort=ty.toLowerCase().indexOf('special')>=0?'Special':'IOR';
if(e.project!==PROJ&&tyShort==='Special')return;
var isCancelled=(e.status==='cancelled');
html+='<div class="evt-row'+(isCancelled?' evt-cancelled':'')+'">';
var timeDisplay=e.flexible_display==='flexible'?'Flexible':fmt(e.inspection_time.substring(0,5));
var duration=e.duration?parseInt(e.duration):60;
var endTime='';
if(e.flexible_display!=='flexible'&&duration){
var startHour=parseInt(e.inspection_time.substring(0,2));
var startMin=parseInt(e.inspection_time.substring(3,5));
var endMin=startHour*60+startMin+duration;
var endHour=Math.floor(endMin/60);
var endMinutes=endMin%60;
if(endHour>=24)endHour-=24;
endTime=' - '+fmt(pad(endHour)+':'+pad(endMinutes));
}
html+='<span class="evt-time">'+timeDisplay+endTime+'</span>';
html+=' — '+e.project+' — <span class="evt-type">'+tyShort+'</span>';
if(isCancelled)html+='<span class="cancelled-label">CANCELLED</span>';
if(e.submitted_by)html+='<div class="evt-who">Submitted by: '+e.submitted_by+'</div>';
if(e.notes)html+='<div class="evt-notes">'+e.notes+'</div>';
if(!isCancelled&&e.project===PROJ){
html+='<div class="evt-actions">';
html+='<button class="btn-edit" onclick="editInsp(\''+e.id+'\',\''+e.inspection_date+'\',\''+e.inspection_time.substring(0,5)+'\')">Edit</button>';
html+='<button class="btn-cancel" onclick="cancelInsp(\''+e.id+'\',\''+e.project+'\',\''+tyShort+'\',\''+e.inspection_date+'\',\''+e.inspection_time.substring(0,5)+'\')">Cancel</button>';
html+='</div>';
}
html+='</div>';
});
list.innerHTML=html;
}
wrap.style.display='block';
}
function getTeamNames(){var names=[];document.querySelectorAll('#iName option').forEach(function(o){if(o.value&&o.value!=='__other__')names.push(o.value);});return names;}
function showActionModal(title,names,callback){
var overlay=document.createElement('div');
overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:999;display:flex;align-items:center;justify-content:center;';
var box=document.createElement('div');
box.style.cssText='background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px;width:280px;';
var h=document.createElement('div');
h.style.cssText='font-size:14px;font-weight:bold;color:#fff;margin-bottom:12px;';
h.textContent=title;
box.appendChild(h);
names.forEach(function(n){
var btn=document.createElement('button');
btn.style.cssText='display:block;width:100%;padding:12px;margin-bottom:8px;font-size:14px;font-weight:600;color:#fff;background:#222;border:1px solid #444;border-radius:6px;cursor:pointer;text-align:left;';
btn.textContent=n;
btn.onclick=function(){document.body.removeChild(overlay);callback(n);};
box.appendChild(btn);
});
var cancel=document.createElement('button');
cancel.style.cssText='display:block;width:100%;padding:10px;font-size:13px;color:#888;background:transparent;border:1px solid #333;border-radius:6px;cursor:pointer;margin-top:4px;';
cancel.textContent='Never mind';
cancel.onclick=function(){document.body.removeChild(overlay);};
box.appendChild(cancel);
overlay.appendChild(box);
document.body.appendChild(overlay);
}
function cancelInsp(id,proj,ty,date,time){
showActionModal('Who is cancelling this inspection?',getTeamNames(),function(who){
var reason=prompt('Reason for cancellation (optional):');
fetch(SB+'/functions/v1/update-inspection',{
method:'POST',
headers:{'Authorization':'Bearer '+AK,'apikey':AK,'Content-Type':'application/json'},
body:JSON.stringify({request_id:id,action:'cancel',action_by:who,reason:reason||''})
}).then(function(r){return r.json();}).then(function(data){
if(data.success){alert('Inspection cancelled.');loadMD();}
else{alert('Error: '+(data.error||'Unknown'));}
}).catch(function(){alert('Connection error.');});
});
}
function editInsp(id,oldDate,oldTime){
showActionModal('Who is editing this inspection?',getTeamNames(),function(who){
showEditModal(id,oldDate,oldTime,who);
});
}
function showEditModal(id,oldDate,oldTime,who){
var overlay=document.createElement('div');
overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
var modal=document.createElement('div');
modal.style.cssText='background:#1a1a1a;border-radius:12px;padding:30px;max-width:400px;width:100%;border:1px solid #333;';
modal.innerHTML=`
<h3 style="color:#e8742a;margin:0 0 20px 0;">Edit Inspection</h3>
<div style="margin-bottom:15px;">
<label style="display:block;color:#ccc;margin-bottom:5px;font-size:14px;">Date</label>
<input type="date" id="editDate" value="${oldDate}" style="width:100%;background:#333;color:#fff;border:1px solid #555;padding:12px;border-radius:6px;font-size:14px;box-sizing:border-box;">
</div>
<div style="margin-bottom:15px;">
<label style="display:block;color:#ccc;margin-bottom:5px;font-size:14px;">Time</label>
<input type="time" id="editTime" value="${oldTime}" style="width:100%;background:#333;color:#fff;border:1px solid #555;padding:12px;border-radius:6px;font-size:14px;box-sizing:border-box;">
</div>
<div style="margin-bottom:20px;">
<label style="display:block;color:#ccc;margin-bottom:5px;font-size:14px;">Reason for change (optional)</label>
<textarea id="editReason" rows="2" placeholder="Why is this being changed?" style="width:100%;background:#333;color:#fff;border:1px solid #555;padding:12px;border-radius:6px;font-size:14px;box-sizing:border-box;"></textarea>
</div>
<div style="display:flex;gap:10px;">
<button onclick="document.body.removeChild(document.querySelector('[data-edit-modal]'))" style="flex:1;background:#555;color:#fff;padding:12px;border:none;border-radius:6px;cursor:pointer;">Cancel</button>
<button onclick="submitEdit('${id}','${who}')" style="flex:1;background:#e8742a;color:#fff;padding:12px;border:none;border-radius:6px;cursor:pointer;">Save Changes</button>
</div>
`;
overlay.setAttribute('data-edit-modal','true');
overlay.appendChild(modal);
document.body.appendChild(overlay);
}
function submitEdit(id,who){
var newDate=document.getElementById('editDate').value;
var newTime=document.getElementById('editTime').value;
var reason=document.getElementById('editReason').value;
if(!newDate||!newTime){alert('Please enter both date and time.');return;}
fetch(SB+'/functions/v1/update-inspection',{
method:'POST',
headers:{'Authorization':'Bearer '+AK,'apikey':AK,'Content-Type':'application/json'},
body:JSON.stringify({request_id:id,action:'edit',action_by:who,new_date:newDate,new_time:newTime,reason:reason||''})
}).then(function(r){return r.json();}).then(function(data){
if(data.success){
alert('Inspection updated successfully.');
document.body.removeChild(document.querySelector('[data-edit-modal]'));
loadMD();
}else{alert('Error: '+(data.error||'Unknown'));}
}).catch(function(){alert('Connection error.');});
}
function loadMD(){
var s=cY+'-'+pad(cM+1)+'-01',ed=new Date(cY,cM+1,0).getDate(),e=cY+'-'+pad(cM+1)+'-'+pad(ed);
fetch(SB+'/rest/v1/inspection_requests?select=id,inspection_date,inspection_time,inspection_types,project,gc,submitted_by,notes,status,flexible_display&inspection_date=gte.'+s+'&inspection_date=lte.'+e+'&order=inspection_date,inspection_time',{
headers:{'apikey':AK,'Authorization':'Bearer '+AK}
}).then(function(r){return r.json();}).then(function(data){
mD={};allEvents=data;
data.forEach(function(v){if(!mD[v.inspection_date])mD[v.inspection_date]=[];mD[v.inspection_date].push(v);});
renderCal();
}).catch(function(){renderCal();});
}
function showPhoto(input){
if(input.files&&input.files[0]){
// Check file size first (10MB limit for photos, 25MB for PDFs)
var maxSize = input.files[0].type === 'application/pdf' ? 25 * 1024 * 1024 : 10 * 1024 * 1024;
if(input.files[0].size > maxSize){
var fileType = input.files[0].type === 'application/pdf' ? 'PDF' : 'photo';
var maxSizeMB = input.files[0].type === 'application/pdf' ? '25MB' : '10MB';
alert('File size too large. ' + fileType + ' must be under ' + maxSizeMB + '. Please compress or resize the file.');
input.value = '';
return;
}
photoFile=input.files[0];
document.getElementById('photoPrompt').style.display='none';
document.getElementById('photoBox').classList.add('has-file');
if(photoFile.type==='application/pdf'){
document.getElementById('photoPreview').style.display='none';
document.getElementById('pdfLabel').style.display='block';
document.getElementById('pdfLabel').innerHTML='&#128196; '+photoFile.name;
}else{
document.getElementById('pdfLabel').style.display='none';
var r=new FileReader();r.onload=function(e){document.getElementById('photoPreview').src=e.target.result;document.getElementById('photoPreview').style.display='block';};r.readAsDataURL(input.files[0]);
}
}
}
function setType(t){inspType=t;document.getElementById('btnSpecial').classList.toggle('active',t==='Special');document.getElementById('btnRegular').classList.toggle('active',t==='IOR');document.getElementById('specialSub').classList.toggle('show',t==='Special');if(t!=='Special')document.getElementById('specialType').selectedIndex=0;}
function setDur(d){inspDur=d;document.querySelectorAll('.dur-btn').forEach(function(b){b.classList.remove('active');});event.target.classList.add('active');}
function toggleOtherName(){var s=document.getElementById('iName');document.getElementById('iNameOther').style.display=s.value==='__other__'?'block':'none';}
function toggleAdditionalEmails(){
var wrap=document.getElementById('additionalEmailsWrap');
var checked=document.getElementById('additionalEmailsCheck').checked;
wrap.style.display=checked?'block':'none';
if(checked&&localStorage.getItem('savedAdditionalEmails')){
document.getElementById('additionalEmailsList').value=localStorage.getItem('savedAdditionalEmails');
}
}
function submitIR(){
var d=document.getElementById('iDate').value,t=document.getElementById('iTime').value,nm=document.getElementById('iName').value.trim(),nt=document.getElementById('iNotes').value.trim();
if(nm==='__other__')nm=document.getElementById('iNameOther').value.trim();
var isFlexible=(t==='flexible');
if(isFlexible)t='07:00';
if(!photoFile||!d||!t||!inspType||!nm||!inspDur){alert('Please fill in all required fields and upload a photo/PDF.');return;}

// Double-check file size before submission
var maxSize = photoFile.type === 'application/pdf' ? 25 * 1024 * 1024 : 10 * 1024 * 1024;
if(photoFile.size > maxSize){
var fileType = photoFile.type === 'application/pdf' ? 'PDF' : 'photo';
var maxSizeMB = photoFile.type === 'application/pdf' ? '25MB' : '10MB';
alert('File size too large. ' + fileType + ' must be under ' + maxSizeMB + '. Please compress or resize the file and try again.');
return;
}

var specType=document.getElementById('specialType').value;
if(inspType==='Special'&&!specType){alert('Please select a Special Inspection Type.');return;}
var emails=[];
// Collect checked team members
document.querySelectorAll('.emailCheck:checked').forEach(function(cb){emails.push(cb.value);});
// Add additional emails if provided
if(document.getElementById('additionalEmailsCheck').checked){
var additionalText=document.getElementById('additionalEmailsList').value.trim();
if(additionalText){
var additionalEmails=additionalText.split(',').map(function(e){return e.trim();}).filter(function(e){return e;});
emails=emails.concat(additionalEmails);
localStorage.setItem('savedAdditionalEmails',additionalText);
}
}
var btn=document.getElementById('submitBtn');btn.textContent='Submitting...';btn.disabled=true;
var fd=new FormData();
fd.append('photo',photoFile);fd.append('mode','photo');fd.append('project','WPMS');fd.append('gc','Lusardi');
fd.append('inspection_date',d);fd.append('inspection_time',t);fd.append('inspection_types',JSON.stringify([inspType]));fd.append('duration',inspDur);
if(isFlexible)fd.append('flexible','true');
if(isFlexible||inspType==='Special')fd.append('skip_conflict','true');
if(inspType==='Special'&&specType)fd.append('special_type',specType);
fd.append('subcontractor','');fd.append('location_detail','');
fd.append('submitted_by',nm);fd.append('notes',nt);
if(emails.length>0){fd.append('email_recipients',JSON.stringify(emails));}
fetch(SB+'/functions/v1/submit-inspection',{method:'POST',headers:{'Authorization':'Bearer '+AK,'apikey':AK},body:fd
}).then(function(r){return r.json();}).then(function(data){
if(data.success){
document.getElementById('requestView').style.display='none';document.getElementById('successView').style.display='block';
document.getElementById('tabBar').style.display='none';document.getElementById('calendarView').style.display='none';
if(emails.length>0){document.getElementById('emailNote').textContent='Copy emailed to '+emails.length+' recipient'+(emails.length>1?'s':'')+'.';document.getElementById('emailNote').style.display='block';}
}else if(data.conflict_project){
var msg='That time is already booked.\n\n';
if(data.day_schedule&&data.day_schedule.length>0){data.day_schedule.forEach(function(s){msg+=fmt(s.inspection_time.substring(0,5))+' — '+s.project+' ('+(s.inspection_types||[]).join(', ')+')\n';});}
msg+='\nPlease pick a different time.';alert(msg);btn.textContent='Submit Inspection Request';btn.disabled=false;
}else{alert('Error: '+(data.error||'Unknown error'));btn.textContent='Submit Inspection Request';btn.disabled=false;}
}).catch(function(){alert('Connection error.');btn.textContent='Submit Inspection Request';btn.disabled=false;});
}
function resetForm(){
document.getElementById('successView').style.display='none';document.getElementById('tabBar').style.display='flex';switchTab('calendar');
document.getElementById('iDate').value='';document.getElementById('iTime').selectedIndex=0;
document.getElementById('photoPreview').style.display='none';document.getElementById('pdfLabel').style.display='none';
document.getElementById('photoPrompt').style.display='block';document.getElementById('photoBox').classList.remove('has-file');
document.getElementById('photoIn').value='';document.getElementById('submitBtn').textContent='Submit Inspection Request';document.getElementById('submitBtn').disabled=false;
document.getElementById('btnSpecial').classList.remove('active');document.getElementById('btnRegular').classList.remove('active');
document.getElementById('specialSub').classList.remove('show');document.getElementById('specialType').selectedIndex=0;
document.querySelectorAll('.emailCheck').forEach(function(cb){cb.checked=false;});
document.getElementById('additionalEmailsCheck').checked=false;document.getElementById('additionalEmailsWrap').style.display='none';
document.getElementById('iName').selectedIndex=0;document.getElementById('iNotes').value='';document.getElementById('iNameOther').value='';document.getElementById('iNameOther').style.display='none';inspType='';inspDur='';photoFile=null;loadMD();
document.querySelectorAll('.dur-btn').forEach(function(b){b.classList.remove('active');});
}
loadMD();
addPermanentEmailCheckboxes();
</script>
</body>
</html>
