<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WPMS Inspection Request</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,sans-serif;max-width:500px;margin:0 auto;padding:12px;background:#111;}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.header img{width:45px;height:45px;border-radius:6px;}
.header h2{font-size:18px;margin-bottom:2px;color:#fff;}
.header p{color:#888;font-size:13px;}
.tabs{display:flex;border-bottom:2px solid #333;margin-bottom:0;}
.tab{flex:1;text-align:center;padding:10px;font-size:14px;font-weight:600;cursor:pointer;color:#666;border-bottom:2px solid transparent;margin-bottom:-2px;}
.tab.active{color:#e8742a;border-bottom-color:#e8742a;}
.card{background:#1a1a1a;border:1px solid #333;border-radius:8px;overflow:hidden;margin-bottom:12px;}
.card-top{border-radius:8px 8px 0 0;border-top:none;}

/* CALENDAR & DAY DETAIL */
.cal-nav{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #333;}
.cal-nav button{background:none;border:none;font-size:18px;cursor:pointer;padding:4px 10px;color:#5a8fc0;}
.cal-nav strong{font-size:15px;color:#5a8fc0;}
.week-row{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;}
.week-header{font-size:11px;color:#666;padding:6px 0;font-weight:600;}
.day-cell{padding:8px 4px;font-size:13px;cursor:pointer;min-height:40px;color:#ccc;}
.day-cell.selected{background:#1e2a3a;border-radius:6px;}
.day-cell.today .day-num{background:#5a8fc0;color:#fff;border-radius:50%;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;}
.day-detail{padding:12px 14px;border-top:1px solid #333;display:none;}
.day-detail-header{font-size:16px;font-weight:bold;color:#5a8fc0;margin-bottom:12px;}
.evt-row{padding:12px;margin-bottom:8px;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid #5a8fc0;font-size:13px;color:#fff;}

/* EVENT ACTIONS (EDIT/CANCEL) */
.evt-actions { display: flex; gap: 8px; margin-top: 8px; }
.btn-edit, .btn-cancel { padding: 5px 12px; border-radius: 4px; font-size: 11px; font-weight: 700; cursor: pointer; background: transparent; text-transform: uppercase; }
.btn-edit { color: #e8742a; border: 1px solid #e8742a; }
.btn-cancel { color: #c44; border: 1px solid #c44; }

/* MULTI-FILE GRID */
.photo-box{border:2px dashed #444;border-radius:8px;padding:20px 16px;text-align:center;background:#1a1a1a;cursor:pointer;margin-bottom:14px;color:#888;}
.file-list-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px; }
.file-item { position: relative; aspect-ratio: 1/1; background: #222; border: 1px solid #333; border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
.file-item img { width: 100%; height: 100%; object-fit: cover; }
.file-item .pdf-indicator { text-align: center; color: #5a8fc0; font-size: 10px; font-weight: bold; padding: 4px; }
.file-item .remove-btn { position: absolute; top: 0; right: 0; background: #e8742a; color: #fff; border: none; width: 22px; height: 22px; font-size: 16px; font-weight: bold; cursor: pointer; border-bottom-left-radius: 6px; line-height: 1; }

/* FORM ELEMENTS */
.form-wrap{background:#1a1a1a;border:1px solid #333;border-top:none;border-radius:0 0 8px 8px;padding:16px;display:none;}
.field-label{display:block;font-weight:bold;font-size:13px;margin-bottom:5px;color:#ccc;}
.field-input{width:100%;padding:10px;font-size:15px;border:1px solid #444;border-radius:6px;margin-bottom:14px;background:#222;color:#fff;}
select.field-input{background:#222;color:#fff;}

.type-btns{display:flex;gap:8px;margin-bottom:14px;}
.type-btn{flex:1;padding:12px;font-size:14px;font-weight:bold;border:2px solid #444;border-radius:8px;background:#222;cursor:pointer;text-align:center;color:#ccc;}
.type-btn.active{background:#e8742a;color:#fff;border-color:#5a8fc0;}
.dur-btns{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;}
.dur-btn{padding:10px 0;font-size:13px;font-weight:600;border:2px solid #444;border-radius:8px;background:#222;cursor:pointer;text-align:center;color:#ccc;flex:1;min-width:55px;}
.dur-btn.active{background:#e8742a;color:#fff;border-color:#5a8fc0;}
.special-sub{display:none;margin-bottom:14px;}
.special-sub.show{display:block;}
.email-list{background:#222;border:1px solid #333;border-radius:6px;padding:8px 12px;margin-bottom:16px;}
.email-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid #333;font-size:13px;color:#ccc;}

/* COLLAPSIBLE LINKS */
.collapsible-section { border-top: 1px solid #333; margin-top: 10px; padding: 5px 0; }
.collapsible-summary { padding: 10px 0; font-size: 13px; color: #5a8fc0; font-weight: 600; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; }
.collapsible-summary::-webkit-details-marker { display: none; }
.collapsible-summary::after { content: '+'; font-size: 16px; font-weight: bold; }
details[open] .collapsible-summary::after { content: 'âˆ’'; }

.submit-btn{width:100%;padding:14px;font-size:15px;font-weight:bold;color:#fff;background:#e8742a;border:none;border-radius:8px;cursor:pointer;margin-top:20px;}
.success-view{display:none;text-align:center;padding:60px 20px;color:#fff;}
.reset-btn{margin-top:16px;padding:10px 20px;font-size:14px;font-weight:bold;color:#5a8fc0;background:none;border:2px solid #5a8fc0;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>
<div class="header">
    <img src="image0-5.jpeg" alt="Logo">
    <div>
        <h2>Inspection Request</h2>
        <p>Woodland Park MOD â€” Lusardi</p>
    </div>
</div>

<div class="tabs" id="tabBar">
<div class="tab active" onclick="switchTab('calendar')">Calendar</div>
<div class="tab" onclick="switchTab('request')">New Request</div>
</div>

<div id="calendarView">
<div class="card card-top" style="border-radius:0;">
<div class="cal-nav">
<button onclick="changeMonth(-1)">&larr;</button>
<strong id="monthLabel"></strong>
<button onclick="changeMonth(1)">&rarr;</button>
</div>
<div class="week-row" style="padding:0 8px;">
<div class="week-header">S</div><div class="week-header">M</div><div class="week-header">T</div><div class="week-header">W</div><div class="week-header">T</div><div class="week-header">F</div><div class="week-header">S</div>
</div>
<div id="calGrid" class="week-row" style="padding:0 8px;"></div>
<div class="day-detail" id="dayDetail">
<div class="day-detail-header" id="dayDetailHeader"></div>
<div id="dayDetailList"></div>
</div>
</div>
<div class="card">
<div style="padding:20px;text-align:center;">
<img src="image0-5.jpeg" alt="Logo" style="width:70px;height:70px;margin-bottom:8px;">
<div style="font-size:22px;font-weight:bold;color:#5a8fc0;">My Daily Reports</div>
<button style="padding:8px 16px;font-size:13px;font-weight:600;color:#fff;background:#e8742a;border:none;border-radius:6px;cursor:pointer;margin-top:10px;" onclick="window.open('https://mydailyreports.org','_blank')">Learn More</button>
</div>
</div>
<div class="card">
<div style="padding:16px;text-align:center;">
<button onclick="showCalendarSubscribe()" style="background:#5a8fc0;color:#fff;padding:12px 24px;border:none;border-radius:6px;font-weight:600;font-size:14px;cursor:pointer;">Subscribe to Calendar</button>
</div>
</div>
</div>

<div id="requestView" class="form-wrap">
<label class="field-label">Photos or PDFs *</label>
<div class="photo-box" onclick="document.getElementById('photoIn').click()">
    <div id="photoPrompt">&#128247; Tap to select multiple photos or PDFs</div>
</div>
<input type="file" id="photoIn" onchange="handleFileSelection(this)" multiple style="display:none;">
<div id="filePreviewGrid" class="file-list-container"></div>

<label class="field-label">Inspection Date *</label>
<input type="date" id="iDate" class="field-input">

<label class="field-label">Inspection Time *</label>
<select id="iTime" class="field-input">
<option value="">Select time</option>
<option value="flexible">Flexible â€” anytime today</option>
<option value="05:00">5:00 AM</option><option value="05:30">5:30 AM</option>
<option value="06:00">6:00 AM</option><option value="06:30">6:30 AM</option>
<option value="07:00">7:00 AM</option><option value="07:30">7:30 AM</option>
<option value="08:00">8:00 AM</option><option value="08:30">8:30 AM</option>
<option value="09:00">9:00 AM</option><option value="09:30">9:30 AM</option>
<option value="10:00">10:00 AM</option><option value="10:30">10:30 AM</option>
<option value="11:00">11:00 AM</option><option value="11:30">11:30 AM</option>
<option value="12:00">12:00 PM</option><option value="12:30">12:30 PM</option>
<option value="13:00">1:00 PM</option><option value="13:30">1:30 PM</option>
<option value="14:00">2:00 PM</option><option value="14:30">2:30 PM</option>
<option value="15:00">3:00 PM</option><option value="15:30">3:30 PM</option>
<option value="16:00">4:00 PM</option><option value="16:30">4:30 PM</option>
<option value="17:00">5:00 PM</option>
</select>

<label class="field-label">Inspection Request # or Summary (Optional)</label>
<input type="text" id="iIdentifier" class="field-input" placeholder="e.g., FDN-003, SLAB-B2" maxlength="50">

<label class="field-label">Duration *</label>
<div class="dur-btns" id="durBtns">
<div class="dur-btn" onclick="setDur('30')">30 min</div>
<div class="dur-btn" onclick="setDur('60')">1 hr</div>
<div class="dur-btn" onclick="setDur('120')">2 hr</div>
<div class="dur-btn" onclick="setDur('240')">4 hr</div>
<div class="dur-btn" onclick="setDur('480')">All Day</div>
</div>

<label class="field-label">Inspection Type *</label>
<div class="type-btns">
<div class="type-btn" id="btnSpecial" onclick="setType('Special')">Special</div>
<div class="type-btn" id="btnRegular" onclick="setType('IOR')">IOR</div>
</div>

<div class="special-sub" id="specialSub">
<label class="field-label">Special Inspection Type *</label>
<select class="field-input" id="specialType">
<option value="">Select type</option>
<option value="Soils">Soils</option><option value="Material ID">Material ID</option>
<option value="Material ID CWI">Material ID CWI</option><option value="Concrete">Concrete</option>
<option value="Bolting">Bolting</option><option value="Pull Test">Pull Test</option>
<option value="Shotcrete">Shotcrete</option><option value="Fireproofing">Fireproofing</option>
</select>
</div>

<label class="field-label">Submitted By *</label>
<select id="iName" class="field-input">
<option value="">Select your name</option>
<option value="other">-- Add name below --</option>
<option value="Jesse Saltzman">Jesse Saltzman</option>
<option value="Ron Davis">Ron Davis</option>
<option value="Scuyler Beltran">Scuyler Beltran</option>
<option value="Alejandro Martinez">Alejandro Martinez</option>
</select>

<label class="field-label">Notes</label>
<textarea id="iNotes" class="field-input" rows="3" placeholder="Optional details"></textarea>

<label class="field-label">Send a copy to:</label>
<div class="email-list">
<label class="email-row"><input type="checkbox" value="saltzman.jesse@gmail.com" class="emailCheck">Jesse Saltzman</label>
<label class="email-row"><input type="checkbox" value="rdavis@lusardi.com" class="emailCheck">Ron Davis (Lusardi)</label>
<label class="email-row"><input type="checkbox" value="sbeltran@lusardi.com" class="emailCheck">Scuyler Beltran (Lusardi)</label>
<label class="email-row"><input type="checkbox" value="amartinez@lusardi.com" class="emailCheck">Alejandro Martinez (Lusardi)</label>
</div>

<details class="collapsible-section">
    <summary class="collapsible-summary">Additional Email Recipients</summary>
    <div style="padding-bottom:10px;">
        <input type="text" id="additionalEmailsList" class="field-input" placeholder="Emails separated by commas">
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:13px;color:#ccc;cursor:pointer;">
            <input type="checkbox" id="saveEmailsCheck"> Save these emails
        </label>
    </div>
</details>

<details class="collapsible-section">
    <summary class="collapsible-summary">Add a New Person to Dropdown</summary>
    <div style="padding:16px;background:#2a2a2a;border-radius:8px;border-left:4px solid #5a8fc0;">
        <div style="color:#5a8fc0;font-weight:600;margin-bottom:8px;">Don't see your name? Add it below:</div>
        <label class="field-label">Your Name</label>
        <input type="text" id="iNewName" class="field-input">
        <label class="field-label">Your Email</label>
        <input type="email" id="iNewEmail" class="field-input">
        <label class="field-label">Company/Role</label>
        <input type="text" id="iNewCompany" class="field-input" placeholder="e.g., (Lusardi), (Testing Lab)">
        <label style="display:flex;align-items:center;gap:8px;margin-size:13px;color:#ccc;cursor:pointer;">
            <input type="checkbox" id="saveNewPersonCheck"> Save for future use
        </label>
    </div>
</details>

<button onclick="submitIR()" id="submitBtn" class="submit-btn">Submit Inspection Request</button>
</div>

<div class="success-view" id="successView" style="display:none; text-align:center; padding:60px 20px; color:#fff;">
<div style="font-size:48px;">&#9989;</div>
<h2>Request Submitted</h2>
<button onclick="resetForm()" style="background:none; border:2px solid #5a8fc0; color:#5a8fc0; padding:10px 20px; border-radius:8px; margin-top:20px; cursor:pointer;">Submit Another</button>
</div>

<script>
var SB='https://esxeusjjeuyhwwrtwpcv.supabase.co';
var PROJ='WPMS';
var AK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeGV1c2pqZXV5aHd3cnR3cGN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3Mzg0MDYsImV4cCI6MjA4NjMxNDQwNn0.dBEhvcxnscwk1gmb3FGYexmLlrzbd60NFzkt4771IvE';
var allFiles=[], inspType='', inspDur='', cM=new Date().getMonth(), cY=new Date().getFullYear(), mD={};

function handleFileSelection(input) {
    var files=Array.from(input.files);
    files.forEach(function(file){
        if(file.size>(file.type==='application/pdf'?25*1024*1024:10*1024*1024)){
            alert(file.name+" is too large."); return;
        }
        allFiles.push(file);
    });
    renderFileGrid(); input.value='';
}
function removeFile(index){ allFiles.splice(index,1); renderFileGrid(); }
function renderFileGrid(){
    var grid=document.getElementById('filePreviewGrid');
    grid.innerHTML='';
    allFiles.forEach(function(file,index){
        var item=document.createElement('div');
        item.className='file-item';
        if(file.type==='application/pdf'){
            item.innerHTML='<div class="pdf-indicator">PDF<br>'+file.name.substring(0,8)+'...</div>';
        } else {
            var img=document.createElement('img');
            img.src=URL.createObjectURL(file); item.appendChild(img);
        }
        var removeBtn=document.createElement('button');
        removeBtn.className='remove-btn'; removeBtn.innerHTML='&times;';
        removeBtn.onclick=function(){removeFile(index);};
        item.appendChild(removeBtn); grid.appendChild(item);
    });
}

function showDay(d){
    var list=document.getElementById('dayDetailList');
    var header=document.getElementById('dayDetailHeader');
    header.textContent="Schedule for "+d;
    var evts=(mD[d]||[]).filter(function(e){return e.status!=='cancelled';});
    if(evts.length===0){
        list.innerHTML='<div style="color:#888;padding:10px;">No inspections scheduled</div>';
    } else {
        var html='';
        evts.forEach(function(e){
            html+='<div class="evt-row">';
            html+='<span class="evt-time">'+(e.flexible_display==='flexible'?'Flexible':e.inspection_time.substring(0,5))+'</span>';
            html+=' â€” <span class="evt-type">'+(e.inspection_types||[]).join(', ')+'</span>';
            if(e.project!==PROJ) html+=' <span style="color:#888;font-size:11px;">('+e.project+')</span>';
            if(e.inspection_identifier) html+='<div style="color:#e8742a;font-weight:700;font-size:13px;margin:4px 0;">'+e.inspection_identifier+'</div>';
            html+='<div style="font-size:11px;color:#888;margin-top:4px;">By: '+e.submitted_by+'</div>';
            if(e.project===PROJ){
                html+='<div class="evt-actions">';
                html+='<button class="btn-edit" onclick="editInsp(\''+e.id+'\',\''+e.inspection_date+'\',\''+e.inspection_time.substring(0,5)+'\')">Edit</button>';
                html+='<button class="btn-cancel" onclick="cancelInsp(\''+e.id+'\',\''+e.project+'\',\'IOR\',\''+e.inspection_date+'\',\''+e.inspection_time.substring(0,5)+'\')">Cancel</button>';
                html+='</div>';
            }
            html+='</div>';
        });
        list.innerHTML=html;
    }
    document.getElementById('dayDetail').style.display='block';
}

function showActionModal(title,names,callback){
var overlay=document.createElement('div');
overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:999;display:flex;align-items:center;justify-content:center;';
var box=document.createElement('div');
box.style.cssText='background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px;width:280px;';
var h=document.createElement('div'); h.style.cssText='font-size:14px;font-weight:bold;color:#fff;margin-bottom:12px;'; h.textContent=title; box.appendChild(h);
names.forEach(function(n){
var btn=document.createElement('button'); btn.style.cssText='display:block;width:100%;padding:12px;margin-bottom:8px;font-size:14px;font-weight:600;color:#fff;background:#222;border:1px solid #444;border-radius:6px;cursor:pointer;text-align:left;'; btn.textContent=n;
btn.onclick=function(){document.body.removeChild(overlay);callback(n);}; box.appendChild(btn);
});
var cancel=document.createElement('button'); cancel.style.cssText='display:block;width:100%;padding:10px;font-size:13px;color:#888;background:transparent;border:1px solid #333;border-radius:6px;cursor:pointer;margin-top:4px;'; cancel.textContent='Never mind';
cancel.onclick=function(){document.body.removeChild(overlay);}; box.appendChild(cancel);
overlay.appendChild(box); document.body.appendChild(overlay);
}

function cancelInsp(id,proj,ty,date,time){
var team=["Jesse Saltzman","Ron Davis","Scuyler Beltran","Alejandro Martinez"];
showActionModal('Who is cancelling this?',team,function(who){
var reason=prompt('Reason (optional):');
fetch(SB+'/functions/v1/update-inspection',{method:'POST',headers:{'Authorization':'Bearer '+AK,'apikey':AK,'Content-Type':'application/json'},body:JSON.stringify({request_id:id,action:'cancel',action_by:who,reason:reason||''})})
.then(function(r){return r.json();}).then(function(data){if(data.success){alert('Cancelled.'); loadMD();} else {alert('Error: '+data.error);}});
});
}

function editInsp(id,oldDate,oldTime){
var team=["Jesse Saltzman","Ron Davis","Scuyler Beltran","Alejandro Martinez"];
showActionModal('Who is editing this?',team,function(who){ showEditModal(id,oldDate,oldTime,who); });
}

function showEditModal(id,oldDate,oldTime,who){
var overlay=document.createElement('div'); overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;';
var modal=document.createElement('div'); modal.style.cssText='background:#1a1a1a;border-radius:12px;padding:30px;max-width:400px;width:100%;border:1px solid #333;';
modal.innerHTML='<h3 style="color:#e8742a;margin-bottom:20px;">Edit Inspection</h3><label style="color:#ccc;font-size:13px;">New Date</label><input type="date" id="eDate" value="'+oldDate+'" class="field-input"><label style="color:#ccc;font-size:13px;">New Time</label><input type="time" id="eTime" value="'+oldTime+'" class="field-input"><div style="display:flex;gap:10px;margin-top:20px;"><button id="cEdit" style="flex:1;background:#333;color:#fff;padding:12px;border:none;border-radius:8px;">Cancel</button><button id="sEdit" style="flex:1;background:#e8742a;color:#fff;padding:12px;border:none;border-radius:8px;">Save</button></div>';
overlay.appendChild(modal); document.body.appendChild(overlay);
document.getElementById('cEdit').onclick=function(){overlay.remove();};
document.getElementById('sEdit').onclick=function(){
var nD=document.getElementById('eDate').value, nT=document.getElementById('eTime').value;
fetch(SB+'/functions/v1/update-inspection',{method:'POST',headers:{'Authorization':'Bearer '+AK,'apikey':AK,'Content-Type':'application/json'},body:JSON.stringify({request_id:id,action:'edit',action_by:who,new_date:nD,new_time:nT})})
.then(function(r){return r.json();}).then(function(data){if(data.success){alert('Updated.'); overlay.remove(); loadMD();} else {alert('Error: '+data.error);}});
};
}

function showCalendarSubscribe(){
var modal=document.createElement('div');
modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
modal.innerHTML='<div style="background:#1a1a1a;max-width:500px;width:100%;border-radius:12px;overflow:hidden;border:1px solid #333;"><div style="background:#5a8fc0;padding:20px;text-align:center;"><h2 style="color:#fff;margin:0;font-size:1.4rem;">ðŸ“… Subscribe to WPMS Calendar</h2></div><div style="padding:30px;text-align:center;"><div style="background:#222;border:2px solid #5a8fc0;border-radius:8px;padding:15px;margin-bottom:25px;"><div style="color:#5a8fc0;font-size:0.9rem;margin-bottom:8px;font-weight:600;">PROJECT URL:</div><div style="color:#fff;font-size:0.9rem;word-break:break-all;">https://esxeusjjeuyhwwrtwpcv.supabase.co/functions/v1/calendar-feed?project=WPMS</div><div id="copyBtn" style="color:#e8742a;font-size:0.8rem;margin-top:8px;cursor:pointer;" onclick="copyCalendarURL()">ðŸ“‹ Tap to Copy URL</div></div><details class="collapsible-section" style="text-align:left;"><summary class="collapsible-summary">iPhone Setup Instructions</summary><div style="padding:10px;font-size:14px;color:#ccc;line-height:1.5;">1. Settings â†’ Calendar â†’ Accounts<br>2. "Add Account" â†’ "Other"<br>3. "Add Subscribed Calendar"<br>4. Paste the Project URL above<br>5. Done!</div></details><details class="collapsible-section" style="text-align:left;"><summary class="collapsible-summary">Android / Google Setup Instructions</summary><div style="padding:10px;font-size:14px;color:#ccc;line-height:1.5;">1. Open Google Calendar on desktop.<br>2. Next to "Other calendars," click (+).<br>3. Select "From URL."<br>4. Paste the Project URL above.</div></details><button onclick="closeCalendarModal()" style="background:#e8742a;color:#fff;padding:12px 30px;border:none;border-radius:6px;font-weight:600;cursor:pointer;margin-top:20px;">Got It</button></div></div>';
document.body.appendChild(modal); window.currentCalendarModal=modal;
}
function copyCalendarURL(){ navigator.clipboard.writeText('https://esxeusjjeuyhwwrtwpcv.supabase.co/functions/v1/calendar-feed?project=WPMS'); document.getElementById('copyBtn').textContent='âœ… URL Copied!'; }
function closeCalendarModal(){ if(window.currentCalendarModal){window.currentCalendarModal.remove(); window.currentCalendarModal=null;} }

function switchTab(t){
document.querySelectorAll('.tab')[0].classList.toggle('active',t==='calendar');
document.querySelectorAll('.tab')[1].classList.toggle('active',t==='request');
document.getElementById('calendarView').style.display=t==='calendar'?'block':'none';
document.getElementById('requestView').style.display=t==='request'?'block':'none';
}
function changeMonth(dir){ cM+=dir; if(cM>11){cM=0;cY++;} if(cM<0){cM=11;cY--;} loadMD(); }
function ds(y,m,d){return y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');}

function loadMD(){
    var base=SB+'/rest/v1/inspection_requests?or=(status.neq.cancelled,status.is.null)';
    var hdrs={headers:{'apikey':AK,'Authorization':'Bearer '+AK}};
    Promise.all([
        fetch(base+'&inspection_types=cs.%7BIOR%7D',hdrs).then(function(r){return r.json();}),
        fetch(base+'&project=eq.WPMS&inspection_types=cs.%7BSpecial%7D',hdrs).then(function(r){return r.json();})
    ]).then(function(res){
        mD={};var seen={};
        res[0].concat(res[1]).forEach(function(v){
            if(seen[v.id])return;seen[v.id]=true;
            if(!mD[v.inspection_date])mD[v.inspection_date]=[];
            mD[v.inspection_date].push(v);
        });
        renderCal();
    });
}

function renderCal(){
    var g=document.getElementById('calGrid');g.innerHTML='';
    document.getElementById('monthLabel').textContent=['January','February','March','April','May','June','July','August','September','October','November','December'][cM]+' '+cY;
    var sd=new Date(cY,cM,1).getDay(),ld=new Date(cY,cM+1,0).getDate();
    for(var i=0;i<sd;i++) g.appendChild(document.createElement('div')).className='day-cell other-month';
    for(var d=1;d<=ld;d++){
        var s=ds(cY,cM,d),c=document.createElement('div');
        c.className='day-cell';c.innerHTML='<span class="day-num">'+d+'</span>';
        if(mD[s]){
            var active=mD[s].filter(function(e){return e.status!=='cancelled';});
            if(active.length>0) c.innerHTML+='<div style="font-size:12px;color:#5a8fc0;font-weight:700;">'+active.length+'</div>';
        }
        c.onclick=(function(x){return function(){showDay(x);};})(s);
        g.appendChild(c);
    }
}

function setType(t){inspType=t;document.getElementById('btnSpecial').classList.toggle('active',t==='Special');document.getElementById('btnRegular').classList.toggle('active',t==='IOR');document.getElementById('specialSub').classList.toggle('show',t==='Special');if(t!=='Special')document.getElementById('specialType').selectedIndex=0;}
function setDur(d){inspDur=d;document.querySelectorAll('.dur-btn').forEach(function(b){b.classList.remove('active');});event.target.classList.add('active');}

function submitIR(){
    var d=document.getElementById('iDate').value, t=document.getElementById('iTime').value, nm=document.getElementById('iName').value;
    var newName=document.getElementById('iNewName').value.trim();
    if((!nm||nm==='other')&&newName){ nm=newName; }
    if(!nm||allFiles.length===0||!d||!t||!inspType||!inspDur){alert('Missing required fields.'); return;}

    var emails=[];
    document.querySelectorAll('.emailCheck:checked').forEach(function(cb){emails.push(cb.value);});
    var addl=document.getElementById('additionalEmailsList').value.trim();
    if(addl) emails=emails.concat(addl.split(',').map(function(e){return e.trim();}));

    var btn=document.getElementById('submitBtn'); btn.textContent='Submitting...'; btn.disabled=true;
    var fd=new FormData();
    allFiles.forEach(function(file,index){fd.append('file_'+index,file);});
    fd.append('project',PROJ); fd.append('gc','Lusardi');
    fd.append('inspection_date',d); fd.append('inspection_time',t);
    fd.append('inspection_types',JSON.stringify([inspType])); fd.append('duration',inspDur);
    fd.append('submitted_by',nm); fd.append('notes',document.getElementById('iNotes').value);
    fd.append('subcontractor','');
    fd.append('location_detail','');
    if(emails.length>0) fd.append('email_recipients',JSON.stringify(emails));
    var idnt=document.getElementById('iIdentifier').value.trim();
    if(idnt) fd.append('inspection_identifier',idnt);

    fetch(SB+'/functions/v1/submit-inspection',{method:'POST',headers:{'Authorization':'Bearer '+AK,'apikey':AK},body:fd})
    .then(function(r){return r.json();}).then(function(data){
        if(data.success){ document.getElementById('requestView').style.display='none'; document.getElementById('successView').style.display='block'; }
        else { alert('Error: '+data.error); btn.disabled=false; btn.textContent='Submit Request'; }
    });
}
function resetForm(){ location.reload(); }
loadMD();
</script>
</body>
</html>
